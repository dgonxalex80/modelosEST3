---
title: <span style="color:#034a94"> **Análisis de Componentes Principales**</span>
author: "Modelos Estadísticos para la toma de decisiones"
output: html_document
css: style.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = NA)

# colores
c1="#FF7F00"
c2="#=EB0C6"
c3="#034A94"
c4="#686868"

# devtools::install_github("kassambara/factoextra") # ultima version
library("factoextra") # visualizacion elegante en ggplot2


```


<br/><br/>

# <span style="color:#034a94">**Introducción**</span>

<br/>

Este análisis consiste en describir la variación producida por las observaciones de $p$ variables aleatorias, mediante un conjunto de nuevas variables que estan correlacionadas entre si, denominadas **componentes** y que estan conformadas por combinación lineal de las variables originales. 

Se utiliza como complemento de los análisis descriptivos y para contribución en modelos predictivos, reduciendo el número de variables empleadas en el modelo.

Las nuevas variables se obtienen en orden de contribución a la variabilidad total de los datos, tal forma que el primer componente describe la mayor cantidad de la variación total del conjunto de variables originales. El segundo componente principal se elige de tal forma que explique la mayor cantidad de la variación total del conjunto de datos que resta sin explicar por el primer componente, bajo la condición de ser independiente de la primera componente y así sucesivamente.

<br/><br/>

Las componente se pueden representar por $CP1$, $CP2$, $CP3$ $\dots$ construidas a partir de un conjunto de $p$ variables, de forma que:


$$V[CP_1] > V[CP_2] > V[CP_3] > \dots > V[CP_p]$$
y  $Cor[CP_i, CP_j] = 0$ para todo para de componentes $i \neq j$

El objetivo principal del ACP es poder ver si las dos o tres primeras componentes explican la mayor parte de la variación de las $p$ variables iniciales. Si es así se pueden considerar estas dos componentes, reduciendo la dimensión de los datos y considerar su representación gráfica.

<br/><br/>

<div class="content-box-gray">
### <span style="color:#686868">**Nota**</span> 

Los procedimientos anteriores están soportados en el supuesto de que las p variables son una combinación lineal de un base que se desea encontrar.

</div>

<br/><br/>

## <span style="color:#034a94">**Determinación de los componentes**</span>

<br/>

El primer componente tiene la forma :

$$CP_{1}  = \beta_{11}X_1+ \beta_{12}X_2 + \dots + \beta_{1p}X_{p} = \displaystyle\sum_{i=1}^{p} \beta_{1i} X_{i} = b'_{1}X$$

Donde $b'= (\beta_{11}, \beta_{12}, \dots , \beta_{1p})$ es el vector de coeficientes a estimar y $X'$ el vector de variables $(X_1, X_2, \dots, X_p)$ que conforma la data.

Para determinar la porción de la varianza total de la data explicada por el componente se define $\Sigma$  

<br/>

$$
\Sigma =
\begin{equation}
\left(
\begin{array}{cccc}
\sigma^2_1 & \sigma_{12} & \cdots & \sigma_{1p} \\
\sigma_{21} & \sigma^2_2 & \cdots & \sigma_{2p} \\
\vdots & \vdots & \ddots & \vdots \\
\sigma_{p1} & \sigma_{2p} & \cdots & \sigma^2_p
\end{array}
\right)
\end{equation}
$$

<br/>

Enconces la varianza del primer componente será :

$$V[CP_1] = V[b'_1 X] = b'_1 \hspace{.1cm}\Sigma \hspace{.1cm} b_1$$
<br/>

Bajo la restricción :

$$\beta_{11}^2  + \beta_{12}^2 + \dots + \beta_{1p} = b'_1 \hspace{.1cm}b_1= 1$$

<br/>

La solución a este sistema se obtiene  mediante el método matemático Multiplicadores de Lagrange que maximiza el valor $\lambda_1$ para la siguiente función :

$$b'_1 \hspace{.1cm}\Sigma \hspace{.1cm}b_1 - \lambda_1 (b'_1 \hspace{.1cm} b_1-1) $$

<br/>

Dando como resultados:

$$CP_1 = b'_1 X$$

El segundo componenete estará determinado por una segunda ecuación de Lagrange con la que se obtiene:


$$CP_2 = b'_2X$$

<br/>

La varianza total de las $p$

$$\displaystyle\sum_{i=1}^p V[X_i] = \sum_{i=1}^p V[CP_i] = \displaystyle\sum_{i=1}^p \lambda_{i}$$
<br/>

De tal forma que la contribución total por cada componente se estimará como:


$$\dfrac{\lambda_{i}}{\displaystyle\sum_{i=1}^p \lambda_{i}}$$


<br/>

Ahora, la contribución de los primeros tres componentes estará dado por :

$$\dfrac{\lambda_{1} + \lambda_2 + \lambda_3}{\displaystyle\sum_{i=1}^p \lambda_{i}}$$

<br/><br/>

### <span style="color:#FF7F00">**Ejemplo**</span> 

<br/>

```{r}
library(paqueteMOD)
data("creditos")
prcomp(creditos[,2:5])
```

<br/><br/>

## <span style="color:#034a94">**Elección del número de componentes principales**</span>

<br/>

```{r}
data(decathlon2)
decathlon2.active <- decathlon2[1:23, 1:10]
head(decathlon2.active[, 1:6])
res.pca <- prcomp(decathlon2.active, scale = TRUE)
fviz_eig(res.pca)

fviz_pca_ind(res.pca,
             col.ind = "cos2", # Color by the quality of representation
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )


fviz_pca_var(res.pca,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )

fviz_pca_biplot(res.pca, repel = TRUE,
                col.var = "#2E9FDF", # Variables color
                col.ind = "#696969"  # Individuals color
                )

```


<br/><br/>

### <span style="color:#FF7F00">**Ejemplo**</span>

<br/>

Para el ejemplo en R se utilizarán las librerias *ade4* y *factoextra*. A continuación se presenta la matriz de datos de distintos tipos de café y seis variables en puntajes de 0 a 10 de algunas caracteristicas que definen la calidad de estos.

<br/>

```{r message = FALSE}
library(ade4); library(factoextra)
data("cafe")

```

<br/>

Calculando el ACP mediante la libreria *ade4* se tiene:

<br/>

```{r}
library(ade4)
p = ncol(cafe) 
n = nrow(cafe)
ACP = dudi.pca(cafe[,2:7], scannf=FALSE, center = TRUE, scale = TRUE, nf=p)
```


<br/>

Mediante los argumentos center = TRUE, scale = TRUE estamos normalizando los datos originales. <br>

Los valores propios asociados a la matriz de correlaciones serán:

<br/>

```{r}
ACP$eig
```

<br/>
Como vemos el primer valor propio será siempre el mayor ya que es el que mayor varianza logra explicar. <br>

Las componentes principales de los individuos son:

<br/>
```{r}
ACP$li
```

Y por ultimo las componentes principales de las variables son:
```{r}
ACP$co	
```

<br/>
Podemos representar mediante un diagrama de barras a los valores propios del ACP.

```{r}
library("factoextra")
fviz_screeplot(ACP, addlabels = TRUE)
```

<br/>

Se evidencia que la primera componente se lleva el 76.7\% de la inercia total, seguida de la segunda componente con un 7.8\% de la varianza explicada, de esta forma el porcentaje de inercia representado en el primer plano factorial es del 84.5\%, perdiendo tan solo un 15.5\% de la información. <br>

<br/><br/>

Gratificando las dos primeras componentes de las variables obtenemos el circulo de correlaciones:



```{r}
library("factoextra")
fviz_pca_var(ACP, repel = TRUE, col.var = "blue")
```

<br/>
Se puede observar que todas las variables son bastante excentricas, por lo que cuentan con una buena calidad de la representación mediante el ACP, podemos ver que las variables que más correlacionadas están son Amargo, Aroma, Cuerpo y Acidez, siendo las variables Astring y Amargo las que menos correlacionadas están entre si. La flecha a donde apunta la variable indica la dirección en donde esta aumenta.

Podemos entonces realizar la representación simultanea de individuos y variables para poder caracterizar los tipos de café:

<br/>
```{r}
library("factoextra")
fviz_pca_biplot(ACP, repel = TRUE, col.var = "blue")
```

Recordemos que las variables están en puntajes. En este caso se puede decir que el tipo de café con la mejor calidad es el ex_o, caracterizándose más por el Aroma, Acidez y el cuerpo. Seguido de este se encuentra el ex_cl, el cual tiene buena puntuación en todas las variables pero se caracteriza más por la astringencia y el aroma. Los cafés con peor calidad son los que se encuentran en dirección contraria a las variables, siendo estos o40m, cl40m, cl20m y cl40cb. Por otra parte tenemos a cl20cb, o40cb y o20m tipos de café con calidad promedio. 

</br> <br/>

Obteniendo las contribuciones a la varianza total de las componentes principales se tiene:

<br/>

```{r}
library("factoextra")
inercia.ACP = inertia.dudi(ACP,row.inertia=TRUE, col.inertia=TRUE)
inercia.ACP$tot.inertia
```

<br/>

Podemos observar que hasta la segunda componente (Ax2) se acumula un 84.51\% de la inercia total. <br>

Las contribuciones de las variables a la varianza explicada de cada componente será:


<br/>

```{r}
inercia.ACP$col.abs
```

Siendo la variable IAroma la que más contribuye a la varianza explicada por el primer eje (20\%), mientras que Astring es la que más contribuye al segundo eje (63.8\%). <br>

<br/>
Por último podemos estudiar las contribuciones de cada individuo a las componentes principales:


<br/>
```{r}
library("factoextra")
inercia.ACP$row.abs
```

Se observa que el café ex_o (27.2\%) es el que más varianza explicada aporta a la primera componente, por otra parte el café o40m (26.3\%) es el que más aporta al segundo eje.


<br/><br/>

